/**
 * Vue Audio Player
 * 
 * –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
 * - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤ –∏–∑ –ø–ª–µ–π–ª–∏—Å—Ç–∞ (mp3, m4a, wav –∏ –¥—Ä.)
 * - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤ —á–µ—Ä–µ–∑ drag&drop –∏–ª–∏ –≤—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –≤—Ä—É—á–Ω—É—é
 * - –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏—Å—Ç, –æ–±–ª–æ–∂–∫–∞) —á–µ—Ä–µ–∑ music-metadata-browser
 * - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º: play, pause, stop, —Å–ª–µ–¥—É—é—â–∏–π/–ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫, loop
 * - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –≤—Ä–µ–º–µ–Ω–∏, –≥—Ä–æ–º–∫–æ—Å—Ç–∏, —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
 * - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–ª–µ–π–ª–∏—Å—Ç, –ø–æ–∑–∏—Ü–∏—è, –≥—Ä–æ–º–∫–æ—Å—Ç—å –∏ –¥—Ä.) –≤ localStorage
 * - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∫—Ä–æ–º–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
 * - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Media Session API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏
 * - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–ø—Ä–æ–±–µ–ª, —Å—Ç—Ä–µ–ª–∫–∏, S)
 * 
 * –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
 * - playlist: –º–∞—Å—Å–∏–≤ —Ç—Ä–µ–∫–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
 * - index: –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
 * - current: –≤—ã—á–∏—Å–ª—è–µ–º—ã–π —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫
 * - audioEl: —Å—Å—ã–ª–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç audio
 * - isPlaying: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
 * - progress, volume, rate, loop, duration, currentTime: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞—É–¥–∏–æ
 * - coverUrl: URL –æ–±–ª–æ–∂–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
 * - dragging: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
 * 
 * –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
 * - play/pause/toggle/stop: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
 * - next/prev/selectTrack: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤
 * - onTimeUpdate/onSeek/onEnded/onLoadedMeta: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏–æ
 * - handleFiles: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
 * - saveState/loadState: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
 * - applyMediaSession: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Media Session API
 * - formatTime: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ú–ú:–°–°
 * 
 * –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª:
 * - onMounted: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Media Session
 * - onBeforeUnmount: –æ—á–∏—Å—Ç–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
 * 
 * UI:
 * - drag&drop –∑–æ–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
 * - –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ —Å –æ–±–ª–æ–∂–∫–æ–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
 * - —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—É–¥–∏–æ (play/pause, –≥—Ä–æ–º–∫–æ—Å—Ç—å, —Å–∫–æ—Ä–æ—Å—Ç—å, loop)
 * - –ø–ª–µ–π–ª–∏—Å—Ç —Å –≤—ã–±–æ—Ä–æ–º —Ç—Ä–µ–∫–∞
 */
<script setup>
import { ref, computed, onMounted, watch, onBeforeUnmount, nextTick } from 'vue'
import { parseBlob } from 'music-metadata-browser'

const LS_KEY = 'vue-audio-state-v1' // –∫–ª—é—á –¥–ª—è localStorage

const playlist = ref([
  { title: 'Lo‚Äëfi Beat', src: '/audio/track1.mp3', artist: 'You' },
  { title: 'Ambient Pad', src: '/audio/track2.mp3', artist: 'You' },
]) // –ø–ª–µ–π–ª–∏—Å—Ç —Å —Ç—Ä–µ–∫–∞–º–∏

const index = ref(0) // –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
const current = computed(() => playlist.value[index.value]) // —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏–∑ –ø–ª–µ–π–ª–∏—Å—Ç–∞

const audioEl = ref(null) // —Å—Å—ã–ª–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç audio
const isPlaying = ref(false) // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
const progress = ref(0)         // –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è 0..1
const volume = ref(0.9)         // –≥—Ä–æ–º–∫–æ—Å—Ç—å 0..1
const rate = ref(1)             // —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è 0.5..2
const loop = ref(false)         // —Ä–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–∞
const duration = ref(0)         // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞
const currentTime = ref(0)      // —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

const coverUrl = ref('') // URL –æ–±–ª–æ–∂–∫–∏ —Ç—Ä–µ–∫–∞
const displayTitle = computed(() => current.value?.title ?? '‚Äî') // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞
const displayArtist = computed(() => current.value?.artist ?? '') // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –∞—Ä—Ç–∏—Å—Ç

function formatTime(s) {
  if (!Number.isFinite(s)) return '0:00' // –µ—Å–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è
  const m = Math.floor(s / 60) // –º–∏–Ω—É—Ç—ã
  const sec = Math.floor(s % 60).toString().padStart(2, '0') // —Å–µ–∫—É–Ω–¥—ã —Å –≤–µ–¥—É—â–∏–º –Ω—É–ª—ë–º
  return `${m}:${sec}` // —Ñ–æ—Ä–º–∞—Ç –ú–ú:–°–°
}
function play()  { audioEl.value?.play() } // –Ω–∞—á–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
function pause() { audioEl.value?.pause() } // –ø–∞—É–∑–∞
function toggle() { isPlaying.value ? pause() : play() } // –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

// —Å—Ç–æ–ø: –ø–∞—É–∑–∞ –∏ —Å–±—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–æ
function stop() { // —Å—Ç–æ–ø: –ø–∞—É–∑–∞ –∏ —Å–±—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–æ
  const a = audioEl.value
  if (!a) return
  a.pause()
  a.currentTime = 0
  isPlaying.value = false
  currentTime.value = 0
  progress.value = 0
  saveStateDebounced()
}

function next() { index.value = (index.value + 1) % playlist.value.length } // —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
function prev() { index.value = (index.value - 1 + playlist.value.length) % playlist.value.length } // –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫

function onTimeUpdate() {
  currentTime.value = audioEl.value.currentTime || 0 // –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
  duration.value = audioEl.value.duration || 0 // –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  progress.value = duration.value ? currentTime.value / duration.value : 0 // –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
  saveStateThrottled() // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–æ–º
}

function onSeek(e) {
  const p = Number(e.target.value) // –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏–∑ input
  progress.value = p // –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
  if (duration.value) audioEl.value.currentTime = duration.value * p // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –≤ audio
  saveStateDebounced() // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –¥–µ–±–∞—É–Ω—Å–æ–º
}

function onEnded() {
  if (!loop.value) next() // –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Ç—Ä–µ–∫–∞ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É, –µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–≤—Ç–æ—Ä–∞
}

function selectTrack(i) { index.value = i } // –≤—ã–±—Ä–∞—Ç—å —Ç—Ä–µ–∫ –ø–æ –∏–Ω–¥–µ–∫—Å—É

const dragging = ref(false) // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
async function handleFiles(fileList) {
  const files = Array.from(fileList).filter(f => f.type.startsWith('audio/')) // –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
  for (const file of files) {
    const url = URL.createObjectURL(file) // —Å–æ–∑–¥–∞—Ç—å URL –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    let metaTitle = file.name.replace(/\.[^.]+$/, '') // –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    let metaArtist = '' // –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ–π
    let coverDataUrl = '' // –æ–±–ª–æ–∂–∫–∞ –≤ base64
    try {
      const mm = await parseBlob(file) // –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
      if (mm.common?.title) metaTitle = mm.common.title // –≤–∑—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
      if (mm.common?.artist) metaArtist = mm.common.artist // –≤–∑—è—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞ –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
      if (mm.common?.picture?.length) {
        const pic = mm.common.picture[0]
        coverDataUrl = `data:${pic.format};base64,${arrayBufferToBase64(pic.data)}` // –ø–æ–ª—É—á–∏—Ç—å –æ–±–ª–æ–∂–∫—É
      }
    } catch (_) {}
    playlist.value.push({
      title: metaTitle,
      artist: metaArtist,
      src: url,
      _localObjectUrl: url, // –ø–æ–º–µ—Ç–∫–∞, —á—Ç–æ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
      cover: coverDataUrl || ''
    })
  }
  if (!isPlaying.value && files.length) {
    index.value = playlist.value.length - files.length // –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫
    await nextTickPlay() // –Ω–∞—á–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
  }
  saveState() // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
}

function onDrop(e) {
  dragging.value = false // —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
  if (e.dataTransfer?.files?.length) handleFiles(e.dataTransfer.files) // –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–∏ drop
}
function onDragOver(e) {
  e.preventDefault() // —Ä–∞–∑—Ä–µ—à–∏—Ç—å drop
  dragging.value = true // –≤–∫–ª—é—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
}
function onDragLeave() { dragging.value = false } // –≤—ã—Ö–æ–¥ –∫—É—Ä—Å–æ—Ä–∞ –∏–∑ –∑–æ–Ω—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è

function onFilePick(e) {
  if (e.target?.files?.length) handleFiles(e.target.files) // –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
}

function arrayBufferToBase64(buffer) {
  let binary = '' // —Å—Ç—Ä–æ–∫–∞ –¥–ª—è base64
  const bytes = new Uint8Array(buffer) // –±–∞–π—Ç—ã –∏–∑ –±—É—Ñ–µ—Ä–∞
  const len = bytes.byteLength
  for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]) // –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –±–∏–Ω–∞—Ä–Ω—É—é —Å—Ç—Ä–æ–∫—É
  return btoa(binary) // base64 –∏–∑ –±–∏–Ω–∞—Ä–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
}

function applyMediaSession() {
  if (!('mediaSession' in navigator)) return // –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ mediaSession
  navigator.mediaSession.metadata = new window.MediaMetadata({
    title: displayTitle.value, // –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞
    artist: displayArtist.value, // –∞—Ä—Ç–∏—Å—Ç
    album: 'Vue Player', // –∞–ª—å–±–æ–º (—Å—Ç–∞—Ç–∏—á–Ω–æ)
    artwork: coverUrl.value ? [{ src: coverUrl.value, sizes: '512x512', type: 'image/png' }] : undefined // –æ–±–ª–æ–∂–∫–∞
  })
}

function refreshCover() { coverUrl.value = current.value?.cover || '' } // –æ–±–Ω–æ–≤–∏—Ç—å URL –æ–±–ª–æ–∂–∫–∏

let lastSave = 0 // –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function saveStateThrottled() {
  const now = performance.now()
  if (now - lastSave > 800) { lastSave = now; saveState() } // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 800 –º—Å
}
let saveTimer // —Ç–∞–π–º–µ—Ä –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∞
function saveStateDebounced() { clearTimeout(saveTimer); saveTimer = setTimeout(saveState, 300) } // –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
function serializePlaylist(pl) {
  return pl.map(t => ({
    title: t.title, artist: t.artist, src: t._localObjectUrl ? null : t.src, cover: t.cover || '' // —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–∞ –¥–ª—è localStorage
  }))
}
function saveState() {
  try {
    const data = {
      index: index.value, // —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
      time: currentTime.value, // —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
      volume: volume.value, // –≥—Ä–æ–º–∫–æ—Å—Ç—å
      rate: rate.value, // —Å–∫–æ—Ä–æ—Å—Ç—å
      loop: loop.value, // –ø–æ–≤—Ç–æ—Ä
      playlist: serializePlaylist(playlist.value), // —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç
      hasLocal: playlist.value.some(t => t._localObjectUrl) // –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
    }
    localStorage.setItem(LS_KEY, JSON.stringify(data)) // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage
  } catch {}
}
function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY) // –ø–æ–ª—É—á–∏—Ç—å –∏–∑ localStorage
    if (!raw) return
    const s = JSON.parse(raw)
    if (Array.isArray(s.playlist) && s.playlist.length) {
      const restored = s.playlist.filter(t => t.src).map(t => ({
        title: t.title, artist: t.artist, src: t.src, cover: t.cover || '' // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç –∏–∑ localStorage (—Ç–æ–ª—å–∫–æ —Å URL)
      }))
      if (restored.length) { playlist.value = restored }
    }
    if (Number.isFinite(s.index)) index.value = Math.min(Math.max(0, s.index), Math.max(0, playlist.value.length - 1)) // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å
    if (Number.isFinite(s.volume)) volume.value = Math.min(Math.max(0, s.volume), 1) // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
    if (Number.isFinite(s.rate)) rate.value = Math.min(Math.max(0.5, s.rate), 2) // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å
    if (typeof s.loop === 'boolean') loop.value = s.loop // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–∞
    if (Number.isFinite(s.time)) pendingResumeTime = s.time // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º—è –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  } catch {}
}
let pendingResumeTime = 0 // –≤—Ä–µ–º—è –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

// –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –≥—Ä–æ–º–∫–æ—Å—Ç—å—é, –æ–±–Ω–æ–≤–ª—è–µ—Ç audio –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
watch(volume, v => { if (audioEl.value) audioEl.value.volume = v; saveStateDebounced() })
// –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å—é, –æ–±–Ω–æ–≤–ª—è–µ—Ç audio –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
watch(rate,   r => { if (audioEl.value) audioEl.value.playbackRate = r; saveStateDebounced() })
// –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ —Ä–µ–∂–∏–º–æ–º –ø–æ–≤—Ç–æ—Ä–∞, –æ–±–Ω–æ–≤–ª—è–µ—Ç audio –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
watch(loop,   l => { if (audioEl.value) audioEl.value.loop = l; saveStateDebounced() })

// –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –∏–Ω–¥–µ–∫—Å–æ–º —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–ª–æ–∂–∫–∏, mediaSession, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
watch(index, async () => {
  await nextTickPlay()
  refreshCover()
  applyMediaSession()
  saveState()
})

// –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
async function nextTickPlay() {
  await nextTick()
  if (!audioEl.value) return
  try { await audioEl.value.play() } catch {}
}

// –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∞—É–¥–∏–æ
function onLoadedMeta() {
  duration.value = audioEl.value.duration || 0 // –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  audioEl.value.volume = volume.value // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
  audioEl.value.playbackRate = rate.value // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å
  audioEl.value.loop = loop.value // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–∞
  if (pendingResumeTime && pendingResumeTime < (audioEl.value.duration || Infinity)) {
    audioEl.value.currentTime = pendingResumeTime // –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
  }
  pendingResumeTime = 0 // —Å–±—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  refreshCover() // –æ–±–Ω–æ–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É
  applyMediaSession() // –æ–±–Ω–æ–≤–∏—Ç—å mediaSession
}

// —Ö—É–∫ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
onMounted(() => {
  loadState() // –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage

  const a = audioEl.value
  a?.addEventListener('play', () => (isPlaying.value = true)) // —Å–ª—É—à–∞—Ç–µ–ª—å play
  a?.addEventListener('pause', () => (isPlaying.value = false)) // —Å–ª—É—à–∞—Ç–µ–ª—å pause

  const onKey = (e) => {
    if (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName)) return // –∏–≥–Ω–æ—Ä –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
    if (e.code === 'Space') { e.preventDefault(); toggle() } // –ø—Ä–æ–±–µ–ª - play/pause
    if (e.code === 'ArrowRight') { a.currentTime = Math.min((a.currentTime||0) + 5, a.duration||Infinity) } // —Å—Ç—Ä–µ–ª–∫–∞ –≤–ø—Ä–∞–≤–æ - –≤–ø–µ—Ä–µ–¥ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥
    if (e.code === 'ArrowLeft')  { a.currentTime = Math.max((a.currentTime||0) - 5, 0) } // —Å—Ç—Ä–µ–ª–∫–∞ –≤–ª–µ–≤–æ - –Ω–∞–∑–∞–¥ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥
    if (e.code === 'ArrowUp')    { volume.value = Math.min(volume.value + 0.05, 1) } // —Å—Ç—Ä–µ–ª–∫–∞ –≤–≤–µ—Ä—Ö - —É–≤–µ–ª–∏—á–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
    if (e.code === 'ArrowDown')  { volume.value = Math.max(volume.value - 0.05, 0) } // —Å—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑ - —É–º–µ–Ω—å—à–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
    if (e.code === 'KeyS')       { stop() } // S ‚Äî —Å—Ç–æ–ø
  }
  window.addEventListener('keydown', onKey) // —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  onBeforeUnmount(() => window.removeEventListener('keydown', onKey)) // –æ—á–∏—Å—Ç–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

  if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', play) // mediaSession play
    navigator.mediaSession.setActionHandler('pause', pause) // mediaSession pause
    navigator.mediaSession.setActionHandler('previoustrack', prev) // mediaSession –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫
    navigator.mediaSession.setActionHandler('nexttrack', next) // mediaSession —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
    navigator.mediaSession.setActionHandler('seekbackward', () => a.currentTime = Math.max((a.currentTime||0)-10, 0)) // –ø–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞–∑–∞–¥
    navigator.mediaSession.setActionHandler('seekforward', () => a.currentTime = Math.min((a.currentTime||0)+10, a.duration||Infinity)) // –ø–µ—Ä–µ–º–æ—Ç–∫–∞ –≤–ø–µ—Ä–µ–¥
    navigator.mediaSession.setActionHandler('stop', stop)
  }
})
</script>


<template>
  <div class="app">
    <h1>üéß Vue Audio Player</h1>

    <div
      class="dropzone"
      :class="{drag: dragging}"
      @dragover="onDragOver"
      @dragleave="onDragLeave"
      @drop="onDrop"
    >
      –ü–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞ –∞—É–¥–∏–æ‚Äë—Ñ–∞–π–ª—ã (mp3, m4a, wav –∏ —Ç.–ø.) –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –≤—Ä—É—á–Ω—É—é.
      <div class="file-btn">
        <input type="file" multiple accept="audio/*" @change="onFilePick" />
      </div>
    </div>

    <div class="card">
      <div class="header">
        <img v-if="coverUrl" :src="coverUrl" class="cover" alt="cover">
        <div style="min-width:0">
          <div style="font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">{{ displayTitle }}</div>
          <div class="time" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap">{{ displayArtist }}</div>
        </div>
      </div>

      <audio
        ref="audioEl"
        :src="current?.src"
        @timeupdate="onTimeUpdate"
        @loadedmetadata="onLoadedMeta"
        @ended="onEnded"
      />
      <div class="row controls" style="margin-bottom:10px">
        <button @click="prev" title="Previous">‚èÆ</button>
        <button @click="toggle" :class="{active:isPlaying}" title="Play/Pause">
          {{ isPlaying ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –ü—É—Å–∫' }}
        </button>
        
        <button @click="next" title="Next">‚è≠</button>

        <div class="time" style="margin-left:auto">
          {{ formatTime(currentTime) }} / {{ formatTime(duration) }}
        </div>
      </div>

      <input
        class="range"
        type="range"
        min="0" max="1" step="0.001"
        :value="progress"
        @input="onSeek"
        aria-label="Seek"
      />

      <div class="row" style="margin-top:10px">
        <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å
          <input type="range" min="0" max="1" step="0.01" v-model.number="volume" />
        </label>

        <label>–°–∫–æ—Ä–æ—Å—Ç—å
          <select v-model.number="rate">
            <option :value="0.75">0.75√ó</option>
            <option :value="1">1√ó</option>
            <option :value="1.25">1.25√ó</option>
            <option :value="1.5">1.5√ó</option>
            <option :value="2">2√ó</option>
          </select>
        </label>

        <button @click="loop = !loop" :class="{active:loop}" title="–ü–æ–≤—Ç–æ—Ä">
          üîÅ Loop {{ loop ? 'On' : 'Off' }}
        </button>
      </div>

      <div class="playlist">
        <h3>–ü–ª–µ–π–ª–∏—Å—Ç</h3>
        <div
          v-for="(t,i) in playlist"
          :key="t.src ?? t.title + i"
          class="track"
          :class="{active: i===index}"
          @click="selectTrack(i)"
          title="–ö–ª–∏–∫ ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ç—Ä–µ–∫"
        >
          <span class="title">
            {{ t.title }}<span v-if="t.artist"> ‚Äî {{ t.artist }}</span>
            <span v-if="!t.src" class="time"> (–ª–æ–∫–∞–ª—å–Ω—ã–π ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ –≤—Ä—É—á–Ω—É—é)</span>
          </span>
          <span class="time">{{ i===index ? '‚ñ∂Ô∏é —Å–µ–π—á–∞—Å' : '' }}</span>
        </div>
      </div>
    </div>
  </div>
</template>